version: 2.1

orbs:
  node: circleci/node@5.1.0
  codecov: codecov/codecov@3.3.0

references:
  workspace_root: &workspace_root
    /home/circleci/bezier-react
  
  cache_paths: &cache_paths
    paths:
      - node_modules/.cache/turbo
      - packages/bezier-react/.turbo
      - packages/bezier-icons/.turbo
      - packages/bezier-figma-plugin/.turbo
      - packages/bezier-codemod/.turbo

      - packages/bezier-react/.stylelintcache
      - packages/bezier-react/.eslintcache
      - packages/bezier-icons/.eslintcache
      - packages/bezier-figma-plugin/.eslintcache
      - packages/bezier-codemod/.eslintcache

      - packages/bezier-react/.jestcache
      - packages/bezier-icons/.jestcache
      - packages/bezier-figma-plugin/.jestcache
      - packages/bezier-codemod/.jestcache

executors:
  node_executor:
    docker:
      - image: node:18.17.1
    resource_class: large
    working_directory: *workspace_root

jobs:
  build:
    executor: node_executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn
      - restore_cache:
          keys:
          - ci-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-
          - ci-{{ .Environment.CACHE_VERSION }}-
      - run: yarn build
      - run: yarn lint typecheck test
      - save_cache:
          key: ci-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-{{ epoch }}
          <<: *cache_paths
      - codecov/upload:
          file: './packages/bezier-react/coverage/lcov.info'

workflows:
  ci:
    jobs:
      - build
