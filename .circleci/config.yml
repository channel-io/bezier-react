version: 2.1

orbs:
  codecov: codecov/codecov@1.2.0
  github: interstellar/github@1.3.2

references:
  workspace_root: &workspace_root
    /home/circleci/bezier-react

  attach_workspace: &attach_workspace
    attach_workspace:
      at: *workspace_root

defaults: &defaults
  resource_class: large
  working_directory: *workspace_root

  docker:
    - image: node:16.2.0

filter_only_tagged: &filter_only_tagged
  filters:
    tags:
      only: /^v.*/
    branches:
      ignore: /.*/

jobs:
  install:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
          - bezier-react-dependencies-{{ checksum "yarn.lock" }}
      - run: yarn install
      - save_cache:
          paths:
            - .yarn/cache
            - .yarn/unplugged
          key: bezier-react-dependencies-{{ checksum "yarn.lock" }}
      - persist_to_workspace:
          root: *workspace_root
          paths:
            - .

  lint:
    <<: *defaults
    steps:
      - *attach_workspace
      - run: yarn lint

  typecheck:
    <<: *defaults
    steps:
      - *attach_workspace
      - run: yarn typecheck

  test:
    <<: *defaults
    steps:
      - *attach_workspace
      - run: yarn test
      - codecov/upload:
          file: './packages/bezier-react/coverage/lcov.info'
          token: $CODECOV_TOKEN

  chromatic-deploy:
    <<: *defaults
    steps:
      - *attach_workspace
      - run: 
          name: Deploy to Chromatic and save the output to a file
          command: yarn workspace @channel.io/bezier-react chromatic --exit-zero-on-changes --skip 'dependabot/**' 2>&1| tee chromatic_log.txt

  comment:
    <<: *defaults
    docker:
      - image: alpine:3.14
    steps:
      - *attach_workspace
      # - TEST
      - run: echo "{{ env.CIRCLE_COMPARE_URL }}" > chromatic_log.txt
      - github/setup-gh-cli:
          github-token-env-var: GITHUB_TOKEN
          when: on_success
      - github/post-pr-comment:
          comment-file: chromatic_log.txt
          comment-title: ðŸš€ Chromatic Deployment
          when: on_success

workflows:
  version: 2
  test_n_chromatic_deploy:
    jobs:
      # - install
      # - lint:
      #     requires:
      #       - install
      # - typecheck:
      #     requires:
      #       - install
      # - test:
      #     requires:
      #       - install
      # - chromatic-deploy:
      #     requires:
      #       - lint
      #       - typecheck
      - comment
          # requires:
          #   - install
