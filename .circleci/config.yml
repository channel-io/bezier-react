version: 2.1

orbs:
  node: circleci/node@5.2.0
  codecov: codecov/codecov@4.0.1

references:
  workspace_root: &workspace_root /home/circleci/bezier-react

  attach_workspace: &attach_workspace
    attach_workspace:
      at: *workspace_root

  turbo_cache_path: &turbo_cache_path
    paths:
      - node_modules/.cache/turbo

  lint_cache_path: &lint_cache_path
    paths:
      - node_modules/.cache/turbo
      - packages/bezier-react/.stylelintcache
      - packages/bezier-react/.eslintcache
      - packages/bezier-icons/.eslintcache
      - packages/bezier-figma-plugin/.eslintcache
      - packages/bezier-codemod/.eslintcache
      - packages/bezier-vscode/.eslintcache

  test_cache_path: &test_cache_path
    paths:
      - node_modules/.cache/turbo
      - packages/bezier-react/.jestcache
      - packages/bezier-codemod/.jestcache

executors:
  node_executor:
    docker:
      - image: node:18.18.2
    resource_class: xlarge
    working_directory: *workspace_root

jobs:
  install-and-build:
    executor: node_executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn
      - restore_cache:
          name: Restore turbo cache
          keys:
            - build-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-
            - build-{{ .Environment.CACHE_VERSION }}-
      - run:
          name: Clean old turbo cache
          command: find ./node_modules/.cache/turbo -mtime +7 -exec rm {} +
      - run: yarn build
      - save_cache:
          name: Save turbo cache
          key: build-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-{{ epoch }}
          <<: *turbo_cache_path
      - persist_to_workspace:
          root: *workspace_root
          paths:
            - .

  lint:
    executor: node_executor
    steps:
      - *attach_workspace
      - restore_cache:
          keys:
            - lint-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-
            - lint-{{ .Environment.CACHE_VERSION }}-
      - run:
          name: Clean old turbo cache
          command: find ./node_modules/.cache/turbo -mtime +7 -exec rm {} +
      - run: yarn lint
      - run:
          name: log eslint cache
          command: ls -lh /home/circleci/bezier-react/packages/bezier-react/.stylelintcache /home/circleci/bezier-react/packages/bezier-react/.eslintcache /home/circleci/bezier-react/packages/bezier-icons/.eslintcache /home/circleci/bezier-react/packages/bezier-figma-plugin/.eslintcache /home/circleci/bezier-react/packages/bezier-codemod/.eslintcache /home/circleci/bezier-react/packages/bezier-vscode/.eslintcache
      - save_cache:
          key: lint-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-{{ epoch }}
          <<: *lint_cache_path

  typecheck:
    executor: node_executor
    steps:
      - *attach_workspace
      - restore_cache:
          keys:
            - typecheck-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-
            - typecheck-{{ .Environment.CACHE_VERSION }}-
      - run: yarn typecheck
      - save_cache:
          key: typecheck-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-{{ epoch }}
          <<: *turbo_cache_path

  test:
    executor: node_executor
    steps:
      - *attach_workspace
      - restore_cache:
          keys:
            - test-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-
            - test-{{ .Environment.CACHE_VERSION }}-
      - run:
          name: Clean old turbo cache
          command: find ./node_modules/.cache/turbo -mtime +7 -exec rm {} +
      - run: yarn test
      - codecov/upload:
          file: './packages/bezier-react/coverage/lcov.info'
      - run:
          name: log cached jest cache
          command: ls -lh /home/circleci/bezier-react/packages/bezier-react/.jestcache /home/circleci/bezier-react/packages/bezier-codemod/.jestcache /home/circleci/bezier-react/node_modules/.cache/turbo
      - run:
          name: log local jest cache
          command: ls -lh packages/bezier-react/.jestcache packages/bezier-codemod/.jestcache
      - save_cache:
          key: test-{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-{{ epoch }}
          <<: *test_cache_path

workflows:
  ci:
    jobs:
      - install-and-build
      - lint:
          requires:
            - install-and-build
      - typecheck:
          requires:
            - install-and-build
      - test:
          requires:
            - install-and-build
